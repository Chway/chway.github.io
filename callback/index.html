<!DOCTYPE html>
<html>

<head>
	<title>Authentication Success</title>
	<script>
		function handleAuthCallback() {
			if (!Object.hasOwn(self, "browser")) { self.browser = self.chrome; }

			const hash = window.location.hash.substring(1); // remove leading #
			const params = new URLSearchParams(hash);

			const oAuthToken = params.get("access_token");
			const state = params.get("state"); // <-- read state

			if (oAuthToken && state) {
				try {
					browser.runtime.sendMessage({
						type: "TWITCH_EXTERNAL_SUCCESS",
						token: oAuthToken,
						state: state // <-- send state back for validation
					});
				} catch (e) {
					console.error("Could not send message to extension:", e);
				}
			} else {
				console.error("Authentication failed or token/state not found.", hash);
				browser.runtime.sendMessage({
					type: "TWITCH_EXTERNAL_FAILURE",
					error: "Token or state missing"
				});
			}

			// Optionally close the tab
			// window.close();
		}

		handleAuthCallback();
	</script>
</head>

<body>
	<h1>Processing Authentication...</h1>
	<p>Please wait...</p>
</body>

</html>